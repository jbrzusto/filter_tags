#include "Run_Foray.hpp"

#include <string.h>

Run_Foray::Run_Foray (Tag_Database &tags, std::istream *data, std::ostream *out) :
  tags(tags),
  data(data),
  out(out),
  line_no(0),
  run_finders()
{
  
};


void
Run_Foray::start() {

  // fields in a line
  double ts;
  int lid;
  char ant_label[MAX_ANT_CODE_SIZE+1];
  int ant_code;
  double sig;
  double lat;
  double lon;
  double freq;
  Nominal_Frequency_kHz nom_freq;

  char codeset[MAX_CODESET_SIZE+1];
  int codeset_id;

  for (;;) {
    // read and parse a line from a .csv file generated by the readDTA.R() function

    char buf[MAX_LINE_SIZE + 1];
    if (! data->getline(buf, MAX_LINE_SIZE)) {
      if (data->eof())
        break;
      continue;
    }

    if (!buf[0])
      continue;

    ++line_no;

    if (8 != sscanf(buf, "%lf,%d,\"%[^\"]\",%lf,%lf,%lf,%lf,\"%[^\"]\"", &ts, &lid, ant_label, &sig, &lat, &lon, &freq, codeset)) {
      std::cerr << "Warning: malformed line in input\n  at line " << line_no << ":\n" << (string("") + buf) << std::endl;
      continue;
    }
    ant_code = Run_Foray::ant_codes.add(std::string(ant_label));
    nom_freq = Freq_Setting::get_closest_nominal_freq(freq);
    codeset_id = Run_Foray::codeset_ids.add(std::string(codeset));

    if (! run_finders.count(nom_freq)) {
      Run_Finder *newrf;
      std::ostringstream prefix;
      prefix << "";
      newrf = new Run_Finder(nom_freq, prefix.str());
      newrf->set_out_stream(out);
      newrf->init();
      run_finders[nom_freq] = newrf;
    }
    Hit h = Hit::make(ts, lid, ant_code, sig, lat, lon, freq, codeset_id);
    run_finders[nom_freq]->process(h);
  }

  // dump any remaining candidates (FIXME: option this once we have resume capability)
  for (auto rfi = run_finders.begin(); rfi != run_finders.end(); ++rfi)
    (rfi->second)->end_processing();
};

Hashed_String_Vector Run_Foray::ant_codes = Hashed_String_Vector();
Hashed_String_Vector Run_Foray::codeset_ids = Hashed_String_Vector();;
